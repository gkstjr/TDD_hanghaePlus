# 프로젝트: 동시성 제어 및 과제 분석

## 동시성 제어란?
- **동시성 제어**는 여러 쓰레드가 동시에 요청을 처리하는 환경에서 데이터의 일관성과 무결성을 보장하기 위한 프로그래밍 기법입니다.
- 여러 쓰레드가 동시에 접근할 때 경합 상태(Race Condition)나 데이터 손실 등의 문제를 방지하는 것이 핵심입니다.

> **쉽게 이해하기**: "공유 자원에 여러 요청이 동시에 접근할 때 문제가 발생할 수 있으므로 동시성 제어가 필요하다."

이 말은 **공유 자원이 없는 상황에서는 동시성 제어가 필요하지 않다**는 것도 의미합니다.

---

## 과제 분석

허재 코치님의 힌트를 바탕으로 구현 방법을 선택하며, 다음과 같은 과정을 거쳤습니다.

### 요구사항 분석
1. **한 번에 하나의 요청 처리**
    - 같은 사용자에 대한 요청은 한 번에 하나만 처리되어야 합니다.
    - 다른 사용자에 대한 요청은 동시에 처리해도 무방합니다.
2. **순서대로 요청 처리**
    - 서버에서 요청 수신 시점을 기준으로 처리 순서를 결정합니다.
    - 요청 객체에 시간을 담아 테스트를 진행할 수 있지만, 클라이언트와 서버 간 시간 동기화 문제로 신뢰할 수 없기 때문에 배제하였습니다.

### 구현 방법

#### 1. 한 번에 하나의 요청 처리
- **ConcurrentHashMap + ReentrantLock**
    - 같은 사용자에 대한 요청 처리에 적합합니다.
    - 단점: 사용자가 많아질수록 메모리 사용량이 증가할 수 있으므로, 일정 시간이 지나면 사용되지 않는 Lock 객체를 제거하는 방법을 추후 구현 예정입니다.

#### 2. 순서대로 요청 처리
- **ReentrantLock의 공정성(Fairness) 설정**
    - 락 대기열에 먼저 들어온 쓰레드를 우선적으로 처리할 수 있습니다.
    - 이를 통해 별도의 큐 관리 없이 순서 보장이 가능합니다.

---

## 과제 구현

### 요청 처리
1. **다른 사용자에 대한 요청**
    - 동시성 제어 없이 동시에 처리 가능하도록 구현.

2. **같은 사용자에 대한 요청**
    - 한 번에 하나의 요청 처리
        - `ConcurrentHashMap`과 `ReentrantLock`을 사용.
    - 순서대로 요청 처리
        - 서버의 요청 수신 시점을 기준으로 처리.
        - **ReentrantLock의 공정성 설정**을 활용하여 별도의 큐 관리 없이 구현.

### 동시성 제어 적용 위치
- **Controller**
    - HTTP 요청을 처리하는 계층으로, 요청을 전달하는 역할에 집중하도록 설계.
    - 동시성 제어는 비즈니스 로직과 밀접하므로 Controller 계층은 적합하지 않음.

- **Service**
    - 동시성 제어는 특정 비즈니스 로직(ex. 포인트 충전 / 사용)의 일관성을 보장하기 위해 필요.
    - Service 계층은 비즈니스 로직을 담당하므로 동시성 제어 코드를 재사용하기에 적합.

### 동시성 제어 통합 테스트

#### 1. 같은 사용자에 대한 요청 테스트
- **목적**: 동시성 제어를 통해 데이터 정합성이 보장되는지 확인.
- **방법**:
    - `ExecutorService`를 사용하여 여러 스레드에서 동시 요청 상황을 만듦.
    - 로그를 통해 요청의 처리 순서를 검증.

#### 2. 같은 사용자에 대한 순차적 요청 테스트
- **목적**: 요청이 순차적으로 처리되는지 확인.
- **방법**:
    - `CountDownLatch`를 이용하여 스레드 간 대기 및 신호 전달.
    - 충전 요청과 사용 요청을 순차적으로 처리하며 요청 완료 후 `countDown()` 호출.

---

## 향후 개선
- **메모리 최적화**: `ConcurrentHashMap`에서 일정 시간이 지나면 사용되지 않는 Lock 객체를 제거하는 방법 도입.
- **특수 이벤트 지원**: `CountDownLatch`를 응용하여 특정 사용자에게 요청 우선권 부여 등 다양한 시나리오를 지원.

---

## 리뷰 요청

- 동시성 제어 로직 테스트와 관련된 새로운 방법이나 개선점이 있다면 피드백 부탁드립니다.
- 구현한 로직에 대해 효율성과 확장성을 함께 고려한 의견을 공유해 주시면 감사하겠습니다! 😊